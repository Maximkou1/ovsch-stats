<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–∞–∑–∞ –û–í–°–ß</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body { background-color: #f4f7f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar { height: 100vh; overflow-y: auto; border-right: 1px solid #dee2e6; background: white; position: sticky; top: 0; }
        .question-box { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .answer-block { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px dashed #ced4da; }
        .btn-show-answer { color: #0d6efd; text-decoration: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
        .btn-show-answer:hover { text-decoration: underline; }
        .stats-table { font-size: 0.85rem; max-height: 250px; overflow-y: auto; line-height: 1.6; }
        .team-link { color: #0d6efd; cursor: pointer; text-decoration: none; font-weight: 500; }
        .team-link:hover { text-decoration: underline; color: #0a58ca; }
        .nav-tabs .nav-link { color: #495057; font-weight: 500; }
        .nav-tabs .nav-link.active { font-weight: 700; color: #0d6efd; }
        .suggestion-item { cursor: pointer; transition: background 0.2s; }
        .suggestion-item:hover { background-color: #f8f9fa; }
        .history-card {
            transition: transform 0.2s;
            border-left: 5px solid;
        }
        .history-card:hover {
            transform: translateX(5px);
        }
        .question-text-full {
            white-space: pre-wrap;
            line-height: 1.5;
            color: #333;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 sidebar p-3 shadow-sm">
            <h5 class="mb-3 px-2">–ú–µ–Ω—é</h5>

            <div class="list-group list-group-flush mb-4 px-2">
                <a href="javascript:void(0)" id="btn-nav-ovsch" class="list-group-item list-group-item-action border rounded-2 mb-2 py-3 active" onclick="showDashboard()">
                    <i class="bi bi-house-door me-2"></i>üèÜ –≠—Ç–∞–ø—ã –û–í–°–ß
                </a>
                <a href="javascript:void(0)" id="btn-nav-analytics" class="list-group-item list-group-item-action border rounded-2 mb-2 py-3" onclick="showGlobalAnalytics()">
                    <i class="bi bi-bar-chart me-2"></i>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–µ
                </a>
            </div>

            <hr>

            <div id="tournamentSidebarSection">
                <h6 class="ps-2 text-muted text-uppercase small fw-bold mb-3">–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø</h6>
                <div id="tournamentList" class="list-group list-group-flush">
                    </div>
            </div>
        </div>

        <div class="col-md-9 p-4">
            <div id="ovschSection">
                <div id="mainHeader" class="mb-4">
                    <h2 id="currentStageTitle" class="display-6">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–∞–∑—É –≤–æ–ø—Ä–æ—Å–æ–≤ –û–í–°–ß!</h2>
                    <div id="typeSelector" class="mt-3 d-none">
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="tournType" id="typeSync" checked onclick="filterType('—Å–∏–Ω—Ö—Ä–æ–Ω')">
                            <label class="btn btn-outline-primary px-4" for="typeSync">üåê –°–∏–Ω—Ö—Ä–æ–Ω</label>

                            <input type="radio" class="btn-check" name="tournType" id="typeAsync" onclick="filterType('–∞—Å–∏–Ω—Ö—Ä–æ–Ω')">
                            <label class="btn btn-outline-primary px-4" for="typeAsync">üïí –ê—Å–∏–Ω—Ö—Ä–æ–Ω</label>
                        </div>
                    </div>
                </div>

                <ul class="nav nav-tabs d-none" id="tournTabs">
                    <li class="nav-item">
                        <a class="nav-link active" id="questions-tab" href="javascript:void(0)" onclick="switchTab('questions')">–í–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="leaderboard-tab" href="javascript:void(0)" onclick="switchTab('leaderboard')">–õ–∏–¥–µ—Ä–±–æ—Ä–¥</a>
                    </li>
                </ul>

                <div id="questionsContainer" class="mt-4"></div>
                <div id="leaderboardContainer" class="mt-4 d-none">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-0">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-4">#</th>
                                        <th>–ö–æ–º–∞–Ω–¥–∞</th>
                                        <th>–ì–æ—Ä–æ–¥</th>
                                        <th class="text-center">–í–∑—è—Ç–æ</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboardBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="globalAnalyticsContainer" class="d-none">
                <h2 class="display-6 mb-4">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–µ</h2>
                <div class="row mb-5">
                    <div class="col-md-6 position-relative">
                        <label class="form-label text-muted small fw-bold">–ü–û–ò–°–ö –ö–û–ú–ê–ù–î–´</label>
                        <input type="text" id="teamSearchInput" class="form-control form-control-lg shadow-sm" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ...">
                        <div id="searchSuggestions" class="list-group shadow position-absolute w-100 mt-1" style="z-index: 1050;"></div>
                    </div>
                </div>

                <div id="globalStatsContent" class="d-none">
                    <div class="row g-4 mb-4">
                        <div class="col-md-3">
                            <div class="card border-0 shadow-sm text-center p-3 h-100">
                                <div class="text-muted small text-uppercase fw-bold">–¢—É—Ä–Ω–∏—Ä–æ–≤ —Å—ã–≥—Ä–∞–Ω–æ</div>
                                <div class="h2 mb-0 mt-2" id="stat-total-t">-</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 shadow-sm text-center p-3 h-100">
                                <div class="text-muted small text-uppercase fw-bold">–¢–æ—á–Ω–æ—Å—Ç—å</div>
                                <div class="h2 mb-0 mt-2 text-primary" id="stat-accuracy">-</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 shadow-sm text-center p-3 h-100">
                                <div class="text-muted small text-uppercase fw-bold">–°—Ä–µ–¥–Ω–µ–µ –º–µ—Å—Ç–æ</div>
                                <div class="h2 mb-0 mt-2" id="stat-avg-rank">-</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 shadow-sm text-center p-3 h-100">
                                <div class="text-muted small text-uppercase fw-bold">–õ—É—á—à–µ–µ / –•—É–¥—à–µ–µ –º–µ—Å—Ç–æ</div>
                                <div class="h2 mb-0 mt-2" id="stat-ranks">-</div>
                            </div>
                        </div>
                    </div>
                    <div id="chartSection" class="card border-0 shadow-sm mb-4 d-none">
                        <div class="card-body">
                            <h5 class="card-title mb-4">–î–∏–Ω–∞–º–∏–∫–∞ –≤–∑—è—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ —ç—Ç–∞–ø–∞–º</h5>
                            <div style="height: 300px;">
                                <canvas id="teamPerformanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div id="teamQuestionsSection" class="mt-5 d-none">
                        <h4 class="mb-3">–ò—Å—Ç–æ—Ä–∏—è –æ—Ç–≤–µ—Ç–æ–≤</h4>
                        <div class="mb-3">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary active" onclick="filterHistory('all')">–í—Å–µ</button>
                                <button class="btn btn-outline-success" onclick="filterHistory('correct')">–í–∑—è—Ç—ã–µ</button>
                                <button class="btn btn-outline-danger" onclick="filterHistory('wrong')">–ù–µ–≤–∑—è—Ç—ã–µ</button>
                            </div>
                        </div>
                        <div id="historyList" class="row g-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="teamModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-light">
        <h5 class="modal-title fw-bold" id="modalTeamName">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <div id="rosterBlock" class="mb-4 p-3 rounded-3 d-none" style="background-color: #e9ecef;">
            <div class="text-uppercase text-muted small fw-bold mb-1">–°–æ—Å—Ç–∞–≤ –Ω–∞ —Ç—É—Ä–Ω–∏—Ä:</div>
            <div id="playerList" class="text-dark"></div>
        </div>
        <div style="position: relative; height:350px;">
            <canvas id="teamChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    let currentTId = null;
    let myChart = null;
    let allTournaments = [];
    let currentStage = null;
    let currentType = '—Å–∏–Ω—Ö—Ä–æ–Ω';

    // –Ω–∞–≤–∏–≥–∞—Ü–∏—è
    function showDashboard() {
        document.getElementById('ovschSection').classList.remove('d-none');
        document.getElementById('globalAnalyticsContainer').classList.add('d-none');
        document.getElementById('tournamentSidebarSection').style.opacity = "1";
        document.getElementById('tournamentSidebarSection').style.pointerEvents = "auto";

        document.getElementById('btn-nav-ovsch').classList.add('active');
        document.getElementById('btn-nav-analytics').classList.remove('active');
    }

    function showGlobalAnalytics() {
        document.getElementById('ovschSection').classList.add('d-none');
        document.getElementById('globalAnalyticsContainer').classList.remove('d-none');

        document.getElementById('tournamentSidebarSection').style.opacity = "0.3";
        document.getElementById('tournamentSidebarSection').style.pointerEvents = "none";

        document.getElementById('btn-nav-analytics').classList.add('active');
        document.getElementById('btn-nav-ovsch').classList.remove('active');

        // —Å–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å —ç—Ç–∞–ø–æ–≤
        document.querySelectorAll('#tournamentList .list-group-item').forEach(el => el.classList.remove('active'));
    }

    async function init() {
        try {
            const res = await fetch('/tournaments');
            allTournaments = await res.json();
            const stageNums = [...new Set(allTournaments.map(t => t.stage))].sort((a, b) => a - b);
            const list = document.getElementById('tournamentList');
            list.innerHTML = stageNums.map(num => `
                <a href="javascript:void(0)" class="list-group-item list-group-item-action border-0 rounded-2 mb-2 py-3 shadow-sm"
                   onclick="selectStage(${num})" id="stage-btn-${num}">
                    <span class="fw-bold">–≠—Ç–∞–ø ${num}</span>
                </a>
            `).join('');
        } catch (e) { console.error(e); }
    }

    function selectStage(num) {
        showDashboard();
        currentStage = num;

        document.querySelectorAll('#tournamentList .list-group-item').forEach(el => el.classList.remove('active'));
        const activeBtn = document.getElementById(`stage-btn-${num}`);
        if(activeBtn) activeBtn.classList.add('active');

        document.getElementById('currentStageTitle').innerText = `–û–í–°–ß 2024/2025. –≠—Ç–∞–ø ${num}`;
        document.getElementById('typeSelector').classList.remove('d-none');
        document.getElementById('tournTabs').classList.remove('d-none');
        filterType(currentType);
    }
    async function filterType(type) {
        currentType = type;
        const tournament = allTournaments.find(t =>
            t.stage === currentStage &&
            (type === '–∞—Å–∏–Ω—Ö—Ä–æ–Ω' ? t.title.toLowerCase().includes('–∞—Å–∏–Ω—Ö—Ä–æ–Ω') : !t.title.toLowerCase().includes('–∞—Å–∏–Ω—Ö—Ä–æ–Ω'))
        );

        if (tournament) {
            currentTId = tournament.id;
            const activeTab = document.getElementById('questions-tab').classList.contains('active') ? 'questions' : 'leaderboard';
            if (activeTab === 'questions') await loadQuestions();
            else await loadLeaderboard();
        } else {
            document.getElementById('questionsContainer').innerHTML = '<div class="alert alert-warning">–¢—É—Ä–Ω–∏—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.</div>';
        }
    }

    async function loadQuestions() {
        const res = await fetch(`/tournament/${currentTId}/questions`);
        const questions = await res.json();
        const container = document.getElementById('questionsContainer');
        container.innerHTML = questions.map(q => `
            <div class="question-box">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="badge bg-secondary px-3 py-2">–í–æ–ø—Ä–æ—Å ${q.number}</span>
                    <small class="text-muted fw-bold">‚úçÔ∏è ${q.author || '‚Äî'}</small>
                </div>
                <div class="lead mb-3">${q.text}</div>
                <a class="btn-show-answer d-inline-block" onclick="toggleAnswer('${q.uid}')">–û—Ç–≤–µ—Ç –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚ñº</a>
                   <div id="ans-${q.uid}" class="answer-block">
                    <div class="p-3 bg-light rounded-3 mb-4 shadow-sm border">
                        <strong class="d-block mb-1 text-uppercase small text-muted">–û—Ç–≤–µ—Ç:</strong>
                        <span class="fs-5">${q.answer}</span>
                    </div>
                    <div id="stats-${q.uid}"><div class="spinner-border spinner-border-sm text-secondary"></div></div>
                </div>
            </div>
        `).join('');
    }

    function switchTab(tab) {
        const qTab = document.getElementById('questions-tab'), lTab = document.getElementById('leaderboard-tab');
        const qCont = document.getElementById('questionsContainer'), lCont = document.getElementById('leaderboardContainer');
        if (tab === 'questions') {
            qCont.classList.remove('d-none'); lCont.classList.add('d-none');
            qTab.classList.add('active'); lTab.classList.remove('active');
            loadQuestions();
        } else {
            qCont.classList.add('d-none'); lCont.classList.remove('d-none');
            qTab.classList.remove('active'); lTab.classList.add('active');
            loadLeaderboard();
        }
    }

    async function toggleAnswer(uid) {
        const block = document.getElementById(`ans-${uid}`);
        if (block.style.display === 'block') block.style.display = 'none';
        else { block.style.display = 'block'; loadStats(uid); }
    }

    async function loadStats(uid) {
        const statsDiv = document.getElementById(`stats-${uid}`);
        const res = await fetch(`/question/${uid}?t_id=${currentTId}`);
        const data = await res.json();
        const teamLink = (id, name) => `<span class="team-link" onclick="showTeamStats('${id}', '${name.replace(/'/g, "\\'")}')">${name}</span>`;
        const ok = data.results.filter(r => r.correct), fail = data.results.filter(r => !r.correct);

        statsDiv.innerHTML = `
            <div class="mb-4 text-center">
                 <span class="badge rounded-pill bg-primary px-4 py-2 fs-6 shadow-sm">–°–ª–æ–∂–Ω–æ—Å—Ç—å: ${data.stats.accuracy_percent}%</span>
            </div>
            <div class="row g-4">
                <div class="col-md-6 border-end">
                    <h6 class="text-success fw-bold mb-3">‚úÖ –í–∑—è–ª–∏ (${ok.length}):</h6>
                    <div class="stats-table">${ok.map(t => teamLink(t.team_id, t.team)).join(', ') || '‚Äî'}</div>
                </div>
                <div class="col-md-6">
                    <h6 class="text-danger fw-bold mb-3">‚ùå –ù–µ –≤–∑—è–ª–∏ (${fail.length}):</h6>
                    <div class="stats-table">${fail.map(t => teamLink(t.team_id, t.team)).join(', ') || '‚Äî'}</div>
                </div>
            </div>`;
    }

    async function loadLeaderboard() {
        const tbody = document.getElementById('leaderboardBody');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center p-5"><div class="spinner-border text-primary"></div></td></tr>';
        const res = await fetch(`/tournament/${currentTId}/leaderboard`);
        const data = await res.json();
        tbody.innerHTML = data.map((row, index) => `
            <tr>
                <td class="ps-4 fw-bold text-muted">${index + 1}</td>
                <td><span class="team-link" onclick="showTeamStats('${row.team_id}', '${row.team.replace(/'/g, "\\'")}')">${row.team}</span></td>
                <td>${row.city || '‚Äî'}</td>
                <td class="text-center"><span class="badge bg-dark fs-6 px-3">${row.score}</span></td>
            </tr>`).join('');
    }

    async function showTeamStats(teamId, teamName) {
        if (!currentTId) return;
        document.getElementById('modalTeamName').innerText = `–ö–æ–º–∞–Ω–¥–∞: ${teamName}`;
        new bootstrap.Modal(document.getElementById('teamModal')).show();
        const [sRes, rRes] = await Promise.all([fetch(`/team_stats/${teamId}/${currentTId}`), fetch(`/team/${teamId}/roster/${currentTId}`)]);
        const sData = await sRes.json(), rData = await rRes.json();

        const rb = document.getElementById('rosterBlock');
        if (rData.length > 0) { rb.classList.remove('d-none'); document.getElementById('playerList').innerText = rData.map(p => p.name).join(', '); }
        else rb.classList.add('d-none');

        const ctx = document.getElementById('teamChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sData.map(d => `${d.num}`),
                datasets: [{
                    label: '–í–∑—è—Ç–æ', data: sData.map(d => d.team_result),
                    backgroundColor: 'rgba(25, 135, 84, 0.6)',
                    borderRadius: 4, order: 2
                }, {
                    label: '–°—Ä–µ–¥–Ω–µ–µ %', data: sData.map(d => d.avg_accuracy),
                    type: 'line', borderColor: '#0d6efd', borderWidth: 2, pointRadius: 3, order: 1, tension: 0.3
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100, grid: { color: 'rgba(0,0,0,0.05)' } },
                    x: { grid: { offset: false }, ticks: { autoSkip: false, font: { size: 10 } } }
                },
                plugins: { legend: { position: 'bottom' }, tooltip: { mode: 'index', intersect: false } }
            }
        });
    }

    // –ª–æ–≥–∏–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
    let searchTimeout;
    document.getElementById('teamSearchInput').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const val = e.target.value;
        if (val.length < 2) { document.getElementById('searchSuggestions').innerHTML = ''; return; }
        searchTimeout = setTimeout(async () => {
            const res = await fetch(`/search_teams?q=${encodeURIComponent(val)}`);
            const teams = await res.json();
            const sugg = document.getElementById('searchSuggestions');
            sugg.innerHTML = teams.map(t => {
                const safeName = t.name.replace(/'/g, "\\'");
                return `
                    <button class="list-group-item list-group-item-action suggestion-item"
                            onclick="loadGlobalTeamStats('${t.id}', '${safeName}')">
                        <div class="fw-bold">${t.name}</div>
                        <small class="text-muted">${t.city || '–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω'}</small>
                    </button>`;
            }).join('');
        }, 300);
    });

    let teamChart = null;

    async function loadGlobalTeamStats(id, name) {
        document.getElementById('searchSuggestions').innerHTML = '';
        document.getElementById('teamSearchInput').value = name;

        const [statsRes, historyRes, chartRes] = await Promise.all([
            fetch(`/team_global_stats/${id}`),
            fetch(`/team_questions_history/${id}`),
            fetch(`/team_chart_stats/${id}`)
        ]);

        const stats = await statsRes.json();
        const historyData = await historyRes.json();
        const chartData = await chartRes.json();

        document.getElementById('globalStatsContent').classList.remove('d-none');

        const cityText = stats.city ? ` (${stats.city})` : '';
        document.querySelector('#globalAnalyticsContainer h2').innerText = `–ê–Ω–∞–ª–∏—Ç–∏–∫–∞: ${stats.name}${cityText}`;

        const rosterHtml = stats.roster && stats.roster.length > 0
            ? `<div class="mb-4 p-3 rounded-3" style="background-color: #e9ecef;">
                   <div class="text-uppercase text-muted small fw-bold mb-1">–°–æ—Å—Ç–∞–≤:</div>
                   <div class="text-dark">${stats.roster.join(', ')}</div>
               </div>`
            : '';

        // —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –ø–µ—Ä–µ–¥ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        const statsRow = document.querySelector('#globalStatsContent .row.g-4');
        let rosterContainer = document.getElementById('globalRosterInfo');
        if (!rosterContainer) {
            rosterContainer = document.createElement('div');
            rosterContainer.id = 'globalRosterInfo';
            statsRow.parentNode.insertBefore(rosterContainer, statsRow);
        }
        rosterContainer.innerHTML = rosterHtml

        // –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
        document.getElementById('globalStatsContent').classList.remove('d-none');
        document.getElementById('stat-total-t').innerText = stats.total_tournaments || 0;
        document.getElementById('stat-accuracy').innerText = (stats.accuracy || 0) + '%';
        document.getElementById('stat-avg-rank').innerText = stats.avg_rank ? stats.avg_rank.toFixed(1) : '-';
        document.getElementById('stat-ranks').innerText = `${stats.best_rank || '-' } / ${stats.worst_rank || '-'}`;

        // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        document.getElementById('chartSection').classList.remove('d-none');
        renderTeamChart(chartData);

        renderHistory(historyData);
    }

    function renderTeamChart(data) {
        const ctx = document.getElementById('teamPerformanceChart').getContext('2d');

        // –µ—Å–ª–∏ –≥—Ä–∞—Ñ–∏–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —É–Ω–∏—á—Ç–æ–∂–∞–µ–º –µ–≥–æ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
        if (teamChart) {
            teamChart.destroy();
        }

        teamChart = new Chart(ctx, {
            type: 'line', // –õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
            data: {
                labels: data.map(d => d.stage_title), // –ù–∞–∑–≤–∞–Ω–∏—è —ç—Ç–∞–ø–æ–≤
                datasets: [{
                    label: '–í–∑—è—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã',
                    data: data.map(d => d.correct_count),
                    borderColor: '#198754', // –¶–≤–µ—Ç –ª–∏–Ω–∏–∏ (success)
                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                    borderWidth: 3,
                    tension: 0.3, // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–∏
                    fill: true,
                    pointRadius: 5,
                    pointBackgroundColor: '#198754'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 36, // –ú–∞–∫—Å–∏–º—É–º –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ —Ç—É—Ä–Ω–∏—Ä–µ –û–í–°–ß
                        ticks: { stepSize: 6 }
                    }
                },
                plugins: {
                    legend: { display: false } // –°–∫—Ä–æ–µ–º –ª–µ–≥–µ–Ω–¥—É –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã
                }
            }
        });
    }

    // –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤
    function renderHistory(items) {
        const container = document.getElementById('historyList');

        const section = document.getElementById('teamQuestionsSection');
        if (section) section.classList.remove('d-none');

        container.innerHTML = items.map(q => `
            <div class="col-12 history-item" data-correct="${q.is_correct}">
                <div class="card border-0 shadow-sm mb-3 border-start border-4 ${q.is_correct ? 'border-success' : 'border-danger'}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted fw-bold">${q.tournament} ‚Äî –í–æ–ø—Ä–æ—Å ${q.number}</small>
                            <span class="badge ${q.is_correct ? 'bg-success' : 'bg-danger'}">
                                ${q.is_correct ? '–í–∑—è—Ç' : '–ù–µ –≤–∑—è—Ç'}
                            </span>
                        </div>
                        <p class="mb-2" style="white-space: pre-wrap;">${q.text}</p>
                        <div class="p-2 bg-light rounded small">
                            <strong>–û—Ç–≤–µ—Ç:</strong> ${q.answer}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ (–≤–∑—è—Ç—ã–µ/–Ω–µ–≤–∑—è—Ç—ã–µ)
    function filterHistory(type) {
        const items = document.querySelectorAll('.history-item');

        event.target.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');

        items.forEach(item => {
            const isCorrect = item.getAttribute('data-correct') === 'true';
            if (type === 'all') item.classList.remove('d-none');
            else if (type === 'correct') isCorrect ? item.classList.remove('d-none') : item.classList.add('d-none');
            else if (type === 'wrong') !isCorrect ? item.classList.remove('d-none') : item.classList.add('d-none');
        });
    }

    init();
</script>
</body>
</html>